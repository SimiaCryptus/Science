<!DOCTYPE html>
<html lang="{{ page.lang | default: site.lang | default: 'en' }}">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" name="viewport">
    <meta content="telephone=no" name="format-detection">
    <meta content="yes" name="mobile-web-app-capable">
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta content="black-translucent" name="apple-mobile-web-app-status-bar-style">
    <base href="{{ site.url }}{{ site.baseurl }}/">

    <!-- SEO Meta Tags -->
    {% include seo_head.html %}
    <!-- MathJax Configuration (loaded early) -->
    {% if page.mathjax or site.mathjax %}
    <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
    <style>
        .mermaid-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: rgba(0, 0, 0, 0.9);
        }

        .mermaid-modal-content {
            margin: auto;
            display: block;
            width: 95%;
            height: 95%;
            position: relative;
            top: 2.5%;
            background: white;
            border-radius: 4px;
            overflow: hidden;
        }

        .mermaid-modal-close {
            position: absolute;
            top: 10px;
            right: 25px;
            color: #f1f1f1;
            font-size: 35px;
            font-weight: bold;
            transition: 0.3s;
            z-index: 10001;
            cursor: pointer;
        }

        .mermaid-modal-close:hover,
        .mermaid-modal-close:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }

        .mermaid svg {
            cursor: pointer;
        }
    </style>
    <div id="mermaid-modal" class="mermaid-modal">
        <span class="mermaid-modal-close">&times;</span>
        <div id="mermaid-modal-content" class="mermaid-modal-content"></div>
    </div>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true,
                tags: 'ams',
                packages: {'[+]': ['ams', 'newcommand', 'configmacros']}
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            startup: {
                pageReady: () => {
                    return MathJax.startup.defaultPageReady().then(() => {
                        console.log('MathJax initial typesetting complete');
                    });
                }
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script async id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
            type="text/javascript">
    </script>
    {% endif %}

    <link href="{{ site.baseurl }}/assets/css/style_v3.css" rel="stylesheet">
    <link href="{{ site.baseurl }}/favicon.ico" rel="icon" type="image/x-icon">
    <link href="{{ site.baseurl }}/assets/images/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png">
    <link href="{{ site.baseurl }}/assets/images/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png">
    <link href="{{ site.baseurl }}/apple-touch-icon.png" rel="apple-touch-icon">
    <link href="{{ site.baseurl }}/assets/images/apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180">
    <link href="{{ site.baseurl }}/site.webmanifest" rel="manifest">
    <meta content="#818cf8" name="theme-color">
    {% feed_meta %}
</head>
<body>
<!-- Floating Particles -->
<div class="particle-field" id="particleField"></div>

{% include theme_switcher.html %}
{% include header.html %}
{% include breadcrumbs.html %}


<article class="post swipeable">
    <header class="post-header">
        <h1 class="post-title">{{ page.title }}</h1>
        <p class="post-meta">
            <time datetime="{{ page.date | date_to_xmlschema }}">
                {{ page.date | date: "%B %d, %Y" }}
            </time>
            {% if page.last_modified %}
            <span class="post-updated">(Updated: {{ page.last_modified | date: "%B %d, %Y" }})</span>
            {% endif %}
            {% if page.author %}
            • <span class="post-author">{{ page.author }}</span>
            {% endif %}
            {% if page.categories.size > 0 %}
            • <span class="post-categories">{{ page.categories | join: ", " }}</span>
            {% endif %}
            {% if page.reading_time_minutes %}
            • <span class="post-reading-time">{{ page.reading_time_minutes }} min read</span>
            {% endif %}
            {% if page.status %}
            • <span class="post-status status-{{ page.status }}">{{ page.status | capitalize }}</span>
            {% endif %}
        </p>
    </header>


    <div class="post-content">
        <!-- Include image optimization -->
        {% include image_optimizer.html %}
        {{ content }}
    </div>

    {% if page.tags.size > 0 %}
    <div class="post-tags">
        <span class="tag-label">Tags:</span>
        {% for tag in page.tags %}
        <a href="{{ tag | slugify | prepend: '/tag/' | append: '/' | relative_url }}" class="tag">{{ tag }}</a>
        {% endfor %}
    </div>
    {% endif %}
</article>

{% assign related_posts_limit = 5 %}
{% assign related_posts_list = "" | split: "" %}

{% comment %} Attempt to find explicitly related documents {% endcomment %}
{% if page.related_documents %}
  {% for rel_path in page.related_documents %}
    {% assign found_post = site.posts | where: "path", rel_path | first %}
    {% unless found_post %}{% assign found_post = site.posts | where: "url", rel_path | first %}{% endunless %}
    {% if found_post %}
      {% assign related_posts_list = related_posts_list | push: found_post %}
    {% endif %}
  {% endfor %}
{% endif %}

{% comment %} Fill with site related posts (LSI or recent) {% endcomment %}
{% assign remaining_slots = related_posts_limit | minus: related_posts_list.size %}
{% if remaining_slots > 0 %}
  {% for post in site.related_posts %}
    {% unless related_posts_list contains post or post.url == page.url %}
      {% assign related_posts_list = related_posts_list | push: post %}
      {% assign remaining_slots = remaining_slots | minus: 1 %}
      {% if remaining_slots == 0 %}{% break %}{% endif %}
    {% endunless %}
  {% endfor %}
{% endif %}

<!--
{% if related_posts_list.size > 0 %}
<nav class="related-posts" style="margin-top: 3rem;">
    <h3 style="margin-bottom: 1rem;">Related Posts</h3>
    <div class="related-posts-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem;">
        {% for post in related_posts_list %}
        <a class="related-post-card touch-target" href="{{ site.baseurl }}{{ post.url }}" 
           style="display: flex; flex-direction: column; padding: 1.25rem; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; text-decoration: none; transition: all 0.3s ease; color: inherit;">
            <h4 class="related-post-title" style="margin: 0 0 0.5rem 0; font-size: 1.1rem; line-height: 1.4; color: inherit;">{{ post.title }}</h4>
            <div class="related-post-meta" style="font-size: 0.85rem; opacity: 0.7; margin-bottom: 0.75rem;">
                <time datetime="{{ post.date | date_to_xmlschema }}">{{ post.date | date: "%B %d, %Y" }}</time>
                {% if post.reading_time_minutes %}
                • <span>{{ post.reading_time_minutes }} min read</span>
                {% endif %}
            </div>
            {% if post.description %}
            <p class="related-post-excerpt" style="font-size: 0.9rem; opacity: 0.8; margin: 0; line-height: 1.5; flex-grow: 1;">
                {{ post.description | truncate: 120 }}
            </p>
            {% endif %}
            {% if post.tags.size > 0 %}
            <div class="related-post-tags" style="margin-top: 1rem; font-size: 0.75rem; opacity: 0.6;">
                {% for tag in post.tags limit:3 %}#{{ tag }} {% endfor %}
            </div>
            {% endif %}
        </a>
        {% endfor %}
    </div>
    <style>
        .related-post-card:hover {
            background: rgba(255,255,255,0.07) !important;
            transform: translateY(-3px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            border-color: rgba(255,255,255,0.2) !important;
        }
    </style>
</nav>
{% endif %}
-->

{% include footer.html %}

<!-- Back to Top Button -->
<div class="back-to-top" id="backToTop">↑</div>

<!-- JavaScript for Effects -->
<script>
    function createParticles() {
        const particleContainer = document.getElementById('particleField');
        if (!particleContainer) return;

        setInterval(() => {
            if (particleContainer.children.length < 20) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDuration = (Math.random() * 10 + 5) + 's';
                particleContainer.appendChild(particle);

                setTimeout(() => {
                    if (particle.parentNode) {
                        particle.parentNode.removeChild(particle);
                    }
                }, 15000);
            }
        }, 500);
    }

    // Back to top functionality
    function initBackToTop() {
        const backToTopButton = document.getElementById('backToTop');
        if (!backToTopButton) return;
        window.addEventListener('scroll', () => {
            if (window.pageYOffset > 300) {
                backToTopButton.classList.add('visible');
            } else {
                backToTopButton.classList.remove('visible');
            }
        });
        backToTopButton.addEventListener('click', () => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });
    }

    // Add glitch effect to random elements
    function addRandomGlitch() {
        const elements = document.querySelectorAll('h1, h2, h3');
        if (elements.length === 0) return;
        setInterval(() => {
            const randomElement = elements[Math.floor(Math.random() * elements.length)];
            randomElement.classList.add('glitch');
            randomElement.setAttribute('data-text', randomElement.textContent);
            setTimeout(() => {
                randomElement.classList.remove('glitch');
            }, 200);
        }, 5000);
    }


    // Initialize effects when page loads
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            createParticles();
            initBackToTop();
            addRandomGlitch();
        });
    } else {
        createParticles();
        initBackToTop();
        addRandomGlitch();
    }
</script>
<!-- Mermaid.js integration -->
{% if page.mermaid or site.mermaid %}
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        mermaid.initialize({
            startOnLoad: false, // Disable automatic start
            theme: 'default', // or 'dark', 'forest', 'neutral'
            securityLevel: 'loose', // Use 'loose' if you have complex diagrams or external links
            // Add other configuration options as needed
        });
        // Transform fenced code blocks with class 'language-mermaid' into mermaid divs.
        // Jekyll/Kramdown with Rouge highlighter typically places the 'language-mermaid' class on the <code> tag,
        // not the <pre> tag. This script finds the <code> tag, extracts its content,
        // and replaces its parent <pre> tag with a new <div class="mermaid">.
        document.querySelectorAll('code.language-mermaid').forEach(function (codeElement) {
            const mermaidDiv = document.createElement('div');
            mermaidDiv.className = 'mermaid';
            mermaidDiv.textContent = codeElement.textContent; // Get the raw diagram definition

            const preElement = codeElement.parentNode; // The <pre> tag is the parent of the <code> tag
            if (preElement && preElement.tagName === 'PRE') {
                preElement.parentNode.replaceChild(mermaidDiv, preElement);
            } else {
                // Fallback: if for some reason the parent isn't a <pre>, replace the code element itself
                codeElement.parentNode.replaceChild(mermaidDiv, codeElement);
            }
        });
        // Manually run Mermaid after transformations
        mermaid.run().catch(err => console.error(err)).then(() => {
            const modal = document.getElementById('mermaid-modal');
            const modalContent = document.getElementById('mermaid-modal-content');
            const closeBtn = document.querySelector('.mermaid-modal-close');
            let panZoomInstance;

            const closeModal = () => {
                modal.style.display = 'none';
                if (panZoomInstance) {
                    panZoomInstance.destroy();
                    panZoomInstance = null;
                }
                modalContent.innerHTML = '';
            };

            closeBtn.onclick = closeModal;

            window.onclick = function (event) {
                if (event.target == modal) {
                    closeModal();
                }
            };

            document.addEventListener('keydown', function (event) {
                if (event.key === "Escape" && modal.style.display === 'block') {
                    closeModal();
                }
            });

            document.querySelectorAll('.mermaid').forEach(div => {
                const svg = div.querySelector('svg');
                if (svg) {
                    div.addEventListener('click', function () {
                        modal.style.display = 'block';
                        const clonedSvg = svg.cloneNode(true);
                        clonedSvg.style.maxWidth = 'none';
                        clonedSvg.style.maxHeight = 'none';
                        clonedSvg.style.width = '100%';
                        clonedSvg.style.height = '100%';
                        modalContent.appendChild(clonedSvg);
                        panZoomInstance = svgPanZoom(clonedSvg, {
                            zoomEnabled: true,
                            controlIconsEnabled: true,
                            fit: true,
                            center: true,
                            minZoom: 0.1,
                            maxZoom: 10
                        });
                    });
                }
            });
        });
    });
</script>
{% endif %}

</body>
</html>